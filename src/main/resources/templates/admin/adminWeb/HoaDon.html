<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="${_csrf.token}">
    <title>Invoice Generator</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">
    <link href="https://cdn.datatables.net/1.10.24/css/dataTables.bootstrap4.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap4.min.js"></script>

    <link rel="stylesheet" href="/path/to/styles.css">
</head>
<body>
<div th:replace="admin/common/header"></div>
<div id="header">
    <h1>Invoice Generator</h1>
    <form action="/create" method="post" th:action="@{/create}">
        <button type="submit" id="createInvoiceBtn" class="btn btn-success">Tạo hóa đơn</button>
    </form>
</div>
<div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
    <span th:text="${errorMessage}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>


<div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
    <span th:text="${successMessage}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
<div id="invoicesContainer">
    <h2>Danh sách hóa đơn</h2>
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link active" href="#" id="unpaidTab" onclick="showTab('unpaid')">Chưa thanh toán</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" id="paidTab" onclick="showTab('paid')">Đã thanh toán</a>
        </li>
    </ul>
    <div id="unpaidInvoices" class="tab-content">
        <table id="unpaidTable" class="table table-bordered">
            <thead class="thead-dark">
            <tr>
                <th></th>
                <th>Mã hóa đơn</th>
                <th>Ngày tạo hóa đơn</th>
                <th>Ngày Thanh Toán</th>
                <th>Trạng thái</th>
                <th>Tổng tiền</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="hoaDon : ${danhSachHoaDonChuaThanhToan}">
                <td>
                    <button class="detailsButton btn btn-success" th:attr="data-hoaDonId=${hoaDon.id}">+</button>
                </td>
                <td th:text="${hoaDon.id}"></td>
                <td th:text="${hoaDon.createDate}"></td>
                <td th:text="${hoaDon.ngayThanhToan}"></td>
                <td th:text="'Chưa thanh toán'"></td>
                <td th:text="${hoaDon.tongTien}"></td>
                <td>
                    <form th:action="@{'/addToCart/' + ${hoaDon.id}}" method="get">
                        <button type="submit" class="btn btn-success">Thêm vào hóa đơn</button>
                    </form>
                    <form th:action="@{'/delete/' + ${hoaDon.id}}" method="post"
                          onsubmit="return confirm('Bạn có chắc chắn muốn xóa hóa đơn này?');">
                        <button type="submit" class="btn btn-danger">Xóa</button>
                    </form>
                    <form th:action="@{'/payment/'+ ${hoaDon.id}}" method="get">
                        <button type="submit" class="btn btn-primary">Thanh toán</button>
                    </form>
                </td>
            </tr>
            <tr th:each="hoaDon : ${danhSachHoaDonChuaThanhToan}" th:id="'details-' + ${hoaDon.id}"
                style="display:none;">
                <td colspan="8">
                    <div>
                        <h3>Chi tiết hóa đơn</h3>
                        <table class="table table-bordered">
                            <thead class="thead-dark">
                            <tr>
                                <th>Tên sản phẩm</th>
                                <th>Màu sắc</th>
                                <th>Kích cỡ</th>
                                <th>Số lượng</th>
                                <th>Giá bán</th>
                                <th>Thành tiền</th>
                                <th>Action</th>
                            </tr>
                            </thead>
                            <tbody th:attr="id='productListBody-' + ${hoaDon.id}">
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div id="paidInvoices" class="tab-content" style="display:none;">
        <table id="paidTable" class="table table-bordered">
            <thead class="thead-dark">
            <tr>
                <th></th>
                <th>Mã hóa đơn</th>
                <th>Ngày tạo hóa đơn</th>
                <th>Ngày Thanh Toán</th>
                <th>Trạng thái</th>
                <th>Tổng tiền</th>
                <th>Tên khách hàng</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="hoaDon : ${danhSachHoaDonDaThanhToan}">
                <td>
                    <button class="detailsButton btn btn-success" th:attr="data-hoaDonId=${hoaDon.id}">+</button>
                </td>
                <td th:text="${hoaDon.id}"></td>
                <td th:text="${hoaDon.createDate}"></td>
                <td th:text="${hoaDon.ngayThanhToan}"></td>
                <td th:text="'Đã thanh toán'"></td>
                <td th:text="${hoaDon.tongTien}"></td>
                <td th:if="${hoaDon.user != null}" th:text="${hoaDon.user.ten + ' - ' + hoaDon.user.sdt}"></td>
            </tr>
            <tr th:each="hoaDon : ${danhSachHoaDonDaThanhToan}" th:id="'details-' + ${hoaDon.id}"
                style="display:none;">
                <td colspan="8">
                    <div>
                        <h3>Chi tiết hóa đơn</h3>
                        <table class="table table-bordered">
                            <thead class="thead-dark">
                            <tr>
                                <th>Tên sản phẩm</th>
                                <th>Màu sắc</th>
                                <th>Kích cỡ</th>
                                <th>Số lượng</th>
                                <th>Giá bán</th>
                                <th>Thành tiền</th>
                                <th>Action</th>
                            </tr>
                            </thead>
                            <tbody th:attr="id='productListBody-' + ${hoaDon.id}">
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>
<div id="updateProductDetailForm" style="display:none;">
    <h3>Sửa sản phẩm chi tiết</h3>
    <form id="updateProductForm" method="post" th:action="@{/updateProductDetail}">
        <input type="hidden" name="hoaDonId" id="updateHoaDonId"/>
        <input type="hidden" name="sanPhamChiTietId" id="updateSanPhamChiTietId"/>

        <div class="form-group">
            <label for="tenSanPham">Tên:</label>
            <input type="text" class="form-control" id="tenSanPham" name="tenSanPham" readonly/>
        </div>

        <div class="form-group">
            <label for="updateKichCo">Kích cỡ:</label>
<!--            <select class="form-control" id="updateKichCo" name="kichCo">-->
<!--                <option value="">Chọn kích cỡ</option>-->
<!--            </select>-->
            <input type="text" class="form-control" id="updateKichCo" name="kichCo" readonly/>
        </div>

        <div class="form-group">
            <label for="updateMauSac">Màu sắc:</label>
            <input type="text" class="form-control" id="updateMauSac" name="mauSac" readonly/>
<!--            <select class="form-control" id="updateMauSac" name="mauSac">-->
<!--                <option value="">Chọn màu sắc</option>-->
<!--            </select>-->
        </div>

        <div class="form-group">
            <label for="updateSoLuong">Số lượng:</label>
            <input type="number" class="form-control" id="updateSoLuong" name="soLuong" min="1" readonly/>
        </div>

        <button type="submit" class="btn btn-success">Cập nhật</button>
        <button type="button" class="btn btn-secondary" onclick="hideUpdateProductForm()">Hủy</button>
    </form>
</div>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const detailsButtons = document.querySelectorAll('.detailsButton');

        detailsButtons.forEach(button => {
            button.addEventListener('click', function (event) {
                event.preventDefault();

                const hoaDonId = button.getAttribute('data-hoaDonId');
                const currentSign = button.textContent.trim();
                if (currentSign === '+') {
                    handleFormSubmit(event, hoaDonId, button);
                } else {
                    hideDetails(hoaDonId, button);
                }
            });
        });

    });

    function handleFormSubmit(event, hoaDonId, button) {
        event.preventDefault();

        const url = `/getDetails/${hoaDonId}`;
        console.log(`Fetching details for invoice ID: ${hoaDonId}`);
        console.log('URL: ' + url);

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Details:', data);
                showDetails(hoaDonId, data, button);
            })
            .catch(error => {
                console.error('Error fetching details:', error);
                alert(`Đã xảy ra lỗi khi lấy chi tiết: ${error.message}`);
            });
    }

    function layHoaDonTheoId(hoaDonId) {
        fetch(`http://localhost:8080/trangThai/${hoaDonId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json(); // Xử lý JSON
            })
            .then(data => {
                console.log('Invoice status:', data);
                const trangThai = data.trangThai;

                // Tìm tất cả các nút xóa liên quan đến hóa đơn này
                const deleteButtons = document.querySelectorAll(`#productListBody-${hoaDonId} .btn-danger`);

                deleteButtons.forEach(deleteButton => {
                    if (trangThai === 'Đã Thanh Toán') {
                        deleteButton.style.display = 'none'; // Ẩn nút nếu đã thanh toán
                    } else if (trangThai === 'Chưa Thanh Toán') {
                        deleteButton.style.display = 'block'; // Hiển thị nút nếu chưa thanh toán
                    } else {
                        console.error(`Unexpected status value: ${trangThai}`);
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching invoice status:', error);
            });
    }


    function showDetails(hoaDonId, data, button) {
        const productListBody = document.getElementById(`productListBody-${hoaDonId}`);
        if (productListBody) {
            productListBody.innerHTML = '';
            data.forEach(product => {
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                <td>${product.sanPham}</td>
                <td>${product.mauSac}</td>
                <td>${product.kichCo}</td>
                <td>${product.soLuong}</td>
                <td>${product.giaBan}</td>
                <td>${product.thanhTien}</td>
                <td>
                    <button type="button" id="deleteButton-${hoaDonId}-${product.sanPhamId}" class="btn btn-danger" onclick="xoaChiTiet(event, '${hoaDonId}', '${product.sanPhamId}')">Xóa</button>
                </td>
                <td>
                    <button type="button" id="updateSP-${hoaDonId}-${product.sanPhamId}" class="btn btn-success" onclick="layThongTinSanPham(event, '${hoaDonId}', '${product.sanPhamId}')">Sửa</button>
                </td>
            `;
                productListBody.appendChild(newRow);
            });
            layHoaDonTheoId(hoaDonId);

            const detailsRow = document.getElementById(`details-${hoaDonId}`);
            if (detailsRow) {
                detailsRow.style.display = 'table-row';
            }
            button.textContent = '-';
        } else {
            console.error(`Không tìm thấy phần tử có id 'productListBody-${hoaDonId}'.`);
        }
    }
    // function layThongTinSanPham(event, hoaDonId, sanPhamChiTietId) {
    //     event.preventDefault();
    //
    //     const url = `/getProductDetail/${hoaDonId}/${sanPhamChiTietId}`;
    //     console.log('Fetching product detail with URL:', url);
    //
    //     fetch(url)
    //         .then(response => {
    //             if (!response.ok) {
    //                 throw new Error('Network response was not ok');
    //             }
    //             return response.json();
    //         })
    //         .then(data => {
    //             console.log('Product detail:', data);
    //             return fetch(`/getColorByShoeName/${encodeURIComponent(data.tenSanPham)}`)
    //                 .then(response => {
    //                     if (!response.ok) {
    //                         throw new Error('Network response was not ok');
    //                     }
    //                     return response.json();
    //                 })
    //                 .then(colorData => {
    //                     console.log('Color data:', colorData);
    //                     const colorSelect = document.getElementById('updateMauSac');
    //                     colorSelect.innerHTML = '<option value="">Chọn màu sắc</option>'; // Reset
    //                     colorData.forEach(color => {
    //                         const option = document.createElement('option');
    //                         option.value = color;
    //                         option.text = color;
    //                         colorSelect.add(option);
    //                     });
    //                     colorSelect.value = data.mauSac;
    //
    //                     return fetch(`/getSizesByColor/${encodeURIComponent(data.mauSac)}/${encodeURIComponent(data.tenSanPham)}`)
    //                         .then(response => {
    //                             if (!response.ok) {
    //                                 throw new Error('Network response was not ok');
    //                             }
    //                             return response.json();
    //                         })
    //                         .then(sizeData => {
    //                             console.log('Size data:', sizeData);
    //
    //                             // Populate size select element
    //                             const sizeSelect = document.getElementById('updateKichCo');
    //                             sizeSelect.innerHTML = '<option value="">Chọn kích cỡ</option>';
    //                             sizeData.forEach(size => {
    //                                 const option = document.createElement('option');
    //                                 option.value = size;
    //                                 option.text = size;
    //                                 sizeSelect.add(option);
    //                             });
    //                             sizeSelect.value = data.kichCo;
    //
    //                             // Populate other fields
    //                             document.getElementById('updateSoLuong').value = data.soLuong || 0;
    //                             document.getElementById('updateHoaDonId').value = hoaDonId;
    //                             document.getElementById('updateSanPhamChiTietId').value = sanPhamChiTietId;
    //                             document.getElementById('tenSanPham').value = data.tenSanPham;
    //
    //                             // Show the update form
    //                             document.getElementById('updateProductDetailForm').style.display = 'block';
    //                         });
    //                 });
    //         })
    //         .catch(error => {
    //             console.error('Error:', error);
    //             alert('Đã xảy ra lỗi khi lấy thông tin sản phẩm.');
    //         });
    // }
    function layThongTinSanPham(event, hoaDonId, sanPhamChiTietId) {
        event.preventDefault();

        const url = `/getProductDetail/${hoaDonId}/${sanPhamChiTietId}`;
        console.log('Fetching product detail with URL:', url);

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Product detail:', data);
                document.getElementById('tenSanPham').value = data.tenSanPham || 'N/A';
                document.getElementById('updateMauSac').value = data.mauSac || 'N/A';
                document.getElementById('updateKichCo').value = data.kichCo || 'N/A';
                document.getElementById('updateSoLuong').value = data.soLuong || 0;
                document.getElementById('updateHoaDonId').value = hoaDonId;
                document.getElementById('updateSanPhamChiTietId').value = sanPhamChiTietId;

                // Show the update form
                document.getElementById('updateProductDetailForm').style.display = 'block';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Đã xảy ra lỗi khi lấy thông tin sản phẩm.');
            });
    }

    function hideUpdateProductForm() {
        document.getElementById('updateProductDetailForm').style.display = 'none';
    }

    function hideDetails(hoaDonId, button) {
        const detailsRow = document.getElementById(`details-${hoaDonId}`);
        if (detailsRow) {
            detailsRow.style.display = 'none';
        }
        button.textContent = '+';
    }

    async function xoaChiTiet(event, hoaDonId, sanPhamId) {
        event.preventDefault();
        const confirmation = confirm('Bạn có chắc chắn muốn xóa sản phẩm này khỏi hóa đơn chi tiết?');
        if (confirmation) {
            const url = `/sanphamct/delete/${hoaDonId}/${sanPhamId}`;
            console.log(url);
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                const responseText = await response.text();
                let responseData;

                try {
                    responseData = JSON.parse(responseText);
                } catch (error) {
                    throw new Error(`Invalid JSON: ${responseText}`);
                }

                if (!response.ok) {
                    throw new Error(responseData.message || 'Network response was not ok');
                }

                // Xử lý xóa thành công
                console.log('Delete request successful', responseData);
                alert(responseData.message || 'Sản phẩm chi tiết đã được xóa thành công');
                // Tải lại trang
                window.location.reload();
            } catch (error) {
                console.error('Error deleting product detail:', error.message);
                alert(`Lỗi khi xóa sản phẩm chi tiết: ${error.message}`);
            }
        }
    }

    function showTab(tabName) {
        const unpaidTab = document.getElementById('unpaidTab');
        const paidTab = document.getElementById('paidTab');
        const unpaidInvoices = document.getElementById('unpaidInvoices');
        const paidInvoices = document.getElementById('paidInvoices');

        if (tabName === 'unpaid') {
            unpaidTab.classList.add('active');
            paidTab.classList.remove('active');
            unpaidInvoices.style.display = 'block';
            paidInvoices.style.display = 'none';
        } else if (tabName === 'paid') {
            unpaidTab.classList.remove('active');
            paidTab.classList.add('active');
            unpaidInvoices.style.display = 'none';
            paidInvoices.style.display = 'block';
        }
    }

    var table = $('#data-table').DataTable({
        pageLength: 5
    });
    $('#searchInput').on('keyup', function () {
        table.search(this.value).draw();
    });
</script>
<style>
    #header {
        text-align: center;
        margin-bottom: 20px;
    }

    .nav-tabs {
        margin-bottom: 20px;
    }

    .nav-tabs .nav-link.active {
        background-color: #007bff;
        color: white;
    }

    .nav-tabs .nav-link {
        color: #007bff;
        cursor: pointer;
    }

    .nav-tabs .nav-link:hover {
        text-decoration: underline;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }

    .table, .table th, .table td {
        border: 1px solid #ddd;
    }

    .table th, .table td {
        padding: 8px;
        text-align: left;
    }

    .table th {
        background-color: #f2f2f2;
        color: black;
    }

    .table tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    .table tr:hover {
        background-color: #f1f1f1;
    }

    .btn {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        cursor: pointer;
    }

    .btn-success {
        background-color: #28a745;
        color: white;
    }

    .btn-info {
        background-color: #17a2b8;
        color: white;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
    }

    .btn-link {
        color: #007bff;
        text-decoration: none;
    }

    .btn-link:hover {
        text-decoration: underline;
    }

    #createInvoiceForm {
        border: 1px solid #ddd;
        padding: 20px;
        margin-bottom: 20px;
    }

    #createInvoiceForm label {
        display: block;
        margin-bottom: 5px;
    }

    #createInvoiceForm input {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
</style>
<script>
    const showFormButton = document.getElementById('createInvoiceBtn');
    const createInvoiceForm = document.getElementById('createInvoiceForm');

    showFormButton.addEventListener('click', function () {
        createInvoiceForm.style.display = 'block';
    });

</script>
</body>
</html>
